<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <a href="pag2"‚ñ∂</a>
    <title>Extrator de Texto</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            max-width: 500px;
            background-color: #f4f4f4;
            color: #333;
            transition: all 0.3s ease;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            resize: none;
            transition: height 0.2s ease;
        }
        .output {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 5px;
        }
        button {
            margin-top: 5px;
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        .copied {
            background: #28a745 !important;
        }
        .dark-mode {
            background-color: #222;
            color: #ddd;
        }
        .dark-mode .output {
            background: #333;
            border-color: #555;
        }
        .dark-mode button {
            background: #444;
            color: #fff;
        }
        .dark-mode button:hover {
            background: #666;
        }
        input {
            position: absolute;
            left: -9999px;
        }
        .dark-mode #inputText {
            background-color: #555;
            color: #ddd;
        }
        .hidden { 
            display: none;
        }
        .reincidencia {
            color: #d9534f;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h2>Extrator de Texto</h2>
    <button onclick="toggleDarkMode()">üåô Modo Escuro</button>
    <br><br>
    <textarea id="inputText" placeholder="Cole seu texto aqui..." oninput="autoResizeTextArea()"></textarea>
    <br>
    <button onclick="extractData()">Extrair Dados</button>
    <button onclick="clearFields()">Limpar</button>
    <button onclick="exportData()">Exportar</button>
    <br><br>
    <p>Contador de textos inseridos: <span id="textCount">0</span></p>
    <p>√öltima extra√ß√£o: <span id="lastExtractionTime">Nunca</span></p>
    <button onclick="extractLastData()">√öltima Extra√ß√£o</button>
    <button onclick="resetCounter()">Reiniciar Contador</button>

    <br><br>
    <button onclick="adjustCounter(1)">+</button>
    <button onclick="adjustCounter(-1)">-</button>

    <div class="output">
        <p><strong>Contrato:</strong> <span id="contrato"></span> 
            <button onclick="copyToClipboard('contrato', this)">Copiar</button>
        </p>
        <p><strong>Raz√£o Social:</strong> <span id="razaoSocial"></span> 
            <button onclick="copyToClipboard('razaoSocial', this)">Copiar</button>
        </p>
        <p><strong>Endere√ßo:</strong> <span id="endereco"></span> 
            <button onclick="copyToClipboard('endereco', this)">Copiar</button>
            <button onclick="openMaps()">üó∫ Abrir no Maps</button>
        </p>
        <p id="reincidenciaMessage" class="reincidencia hidden"></p>
    </div>

    <input type="text" id="hiddenInput">

    <script>
        // Fun√ß√£o para verificar reincid√™ncias
        function checkReincidence(newText) {
            let history = JSON.parse(localStorage.getItem("history") || "[]");
            let currentDate = new Date().getTime();
            let reincidenciaCount = 0;

            // Percorre o hist√≥rico de textos para verificar se h√° coincid√™ncias dentro de um per√≠odo de 3 dias
            history.forEach(entry => {
                if (newText === entry.text && (currentDate - entry.timestamp) <= 259200000) { // 3 dias em milissegundos
                    reincidenciaCount++;
                }
            });

            return reincidenciaCount;
        }

        // Armazena um novo texto no hist√≥rico
        function storeTextInHistory(text) {
            let history = JSON.parse(localStorage.getItem("history") || "[]");
            let currentDate = new Date().getTime();
            history.push({ text: text, timestamp: currentDate });
            localStorage.setItem("history", JSON.stringify(history));

            // Atualiza o contador de textos
            let textCount = parseInt(localStorage.getItem("textCount") || "0");
            textCount++;
            localStorage.setItem("textCount", textCount.toString());
            document.getElementById("textCount").textContent = textCount;

            // Atualiza o hor√°rio da √∫ltima extra√ß√£o
            localStorage.setItem("lastExtractionTime", currentDate);
            document.getElementById("lastExtractionTime").textContent = new Date(currentDate).toLocaleString();
        }

        // Fun√ß√£o para extrair dados do texto e mostrar reincid√™ncia
        function extractData() {
            let text = document.getElementById("inputText").value;

            // Regex melhorado para capturar texto com acentua√ß√£o
            let contrato = text.match(/Contrato:\s*(\d+)/i)?.[1] || "N√£o encontrado";
            let razaoSocial = text.match(/Raz√£o\sSocial:\s*([^\n]+)/i)?.[1]?.trim() || "N√£o encontrado";
            let endereco = text.match(/Endere√ßo:\s*([\s\S]*?)(?=Contato:|$)/i)?.[1]?.trim() || "N√£o encontrado";

            // Atualiza os campos na interface
            document.getElementById("contrato").textContent = contrato;
            document.getElementById("razaoSocial").textContent = razaoSocial;
            document.getElementById("endereco").textContent = endereco;

            // Verifica reincid√™ncia e exibe a mensagem somente a partir da segunda vez
            let reincidenciaCount = checkReincidence(text);
            if (reincidenciaCount > 0) {
                document.getElementById("reincidenciaMessage").classList.remove("hidden");
                document.getElementById("reincidenciaMessage").textContent = `Reincid√™ncia: ${reincidenciaCount} vez(es) nos √∫ltimos 3 dias.`;
            } else {
                document.getElementById("reincidenciaMessage").classList.add("hidden");
            }

            // Armazena o novo texto no hist√≥rico e atualiza o contador
            storeTextInHistory(text);
        }

        function copyToClipboard(id, btn) {
            let text = document.getElementById(id).textContent;
            let hiddenInput = document.getElementById("hiddenInput");

            hiddenInput.value = text;
            hiddenInput.select();
            hiddenInput.setSelectionRange(0, 99999);
            document.execCommand("copy");

            btn.textContent = "Copiado!";
            btn.classList.add("copied");
            setTimeout(() => {
                btn.textContent = "Copiar";
                btn.classList.remove("copied");
            }, 1500);
        }

        function clearFields() {
            document.getElementById("inputText").value = "";
            document.getElementById("contrato").textContent = "";
            document.getElementById("razaoSocial").textContent = "";
            document.getElementById("endereco").textContent = "";
            document.getElementById("reincidenciaMessage").classList.add("hidden");
        }

        function exportData() {
            let contrato = document.getElementById("contrato").textContent;
            let razaoSocial = document.getElementById("razaoSocial").textContent;
            let endereco = document.getElementById("endereco").textContent;

            let content = `Contrato: ${contrato}\nRaz√£o Social: ${razaoSocial}\nEndere√ßo: ${endereco}`;
            let blob = new Blob([content], { type: "text/plain" });
            let a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "dados_extraidos.txt";
            a.click();
        }

        function openMaps() {
            let endereco = document.getElementById("endereco").textContent;
            if (endereco === "N√£o encontrado") {
                alert("Nenhum endere√ßo encontrado para abrir no Maps.");
                return;
            }
            let url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(endereco);
            window.open(url, "_blank");
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }

        function autoResizeTextArea() {
            let textarea = document.getElementById("inputText");
            textarea.style.height = "auto";
            textarea.style.height = (textarea.scrollHeight) + "px";
        }

        // Fun√ß√£o para extrair os √∫ltimos dados extra√≠dos
        function extractLastData() {
            let history = JSON.parse(localStorage.getItem("history") || "[]");
            if (history.length > 0) {
                let lastData = history[history.length - 1].text;
                document.getElementById("inputText").value = lastData;
                extractData(); // Re-extrair os dados do √∫ltimo texto
            }
        }

        // Fun√ß√£o para reiniciar o contador
        function resetCounter() {
            localStorage.setItem("textCount", "0");
            document.getElementById("textCount").textContent = "0";
        }

        // Fun√ß√£o para ajustar o contador (+ ou -)
        function adjustCounter(value) {
            let currentCount = parseInt(localStorage.getItem("textCount") || "0");
            currentCount += value;
            if (currentCount < 0) currentCount = 0;  // Prevenir contador negativo
            localStorage.setItem("textCount", currentCount.toString());
            document.getElementById("textCount").textContent = currentCount;
        }

        // Recupera o contador de textos e hist√≥rico ao carregar a p√°gina
        window.onload = function() {
            let storedTextCount = localStorage.getItem("textCount") || "0";
            document.getElementById("textCount").textContent = storedTextCount;
            let storedLastExtractionTime = localStorage.getItem("lastExtractionTime");
            if (storedLastExtractionTime) {
                document.getElementById("lastExtractionTime").textContent = new Date(parseInt(storedLastExtractionTime)).toLocaleString();
            }
        }
    </script>

</body>
</html>
